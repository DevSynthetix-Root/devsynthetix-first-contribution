name: Smart AI PR Handler

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write      # Merge karne ke liye
  pull-requests: write # Comment aur Label ke liye
  issues: write        # Issue close karne ke liye

jobs:
  smart-ai-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Smart AI Review & Merge
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const actor = context.actor;
            const prBody = context.payload.pull_request.body || "";

            // --- 1. Friendly Reminder for "Closes #" ---
            if (!prBody.toLowerCase().includes('closes #') && !prBody.toLowerCase().includes('fixes #')) {
               await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `üëã **@${actor}**, just a quick reminder:\n\nTo automatically link and close the issue once merged, please update your PR description to include:\n> \`Closes #<issue_number>\`\n\n*(No action needed if you already did this!)*`
              });
            }

            // --- 2. Security & File Integrity Check ---
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });

            // Yahan define hai ki kaunsi files Auto-Merge ke liye safe hain
            const allowedFiles = ['contributors/README.md', 'README.md'];
            
            let fileCheckPassed = true;
            let invalidFiles = [];

            for (const file of files.data) {
              // Agar file allowed list mein nahi hai, toh use note kar lo
              if (!allowedFiles.includes(file.filename)) {
                fileCheckPassed = false;
                invalidFiles.push(file.filename);
              }
            }

            // --- 3. Conflict Check (Safety First) ---
            const prDetails = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const isMergeable = prDetails.data.mergeable;

            // ===========================================
            //              AI LOGIC CORE
            // ===========================================

            // CASE A: Unauthorized Files Modified (Manual Review Needed)
            if (!fileCheckPassed) {
               // Professional Message listing the specific files
               const fileList = invalidFiles.map(f => `\`${f}\``).join(', ');
               
               await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `### ‚ö†Ô∏è Manual Review Required

                Hello **@${actor}**, thank you for your contribution!
                
                I have analyzed your code, and it looks promising. However, the system detected changes to files that are outside the automatic merge scope:
                - ${fileList}

                **Status:**
                To ensure the integrity of the project structure, these changes require a manual review by a maintainer.
                
                ‚úÖ **Next Steps:** No further action is required from you. The team has been notified and will review your PR shortly.`
              });
              
              // Label laga do taaki Admin ko dikh jaye
              await github.rest.issues.addLabels({
                owner, repo, issue_number: prNumber, labels: ['needs-manual-review', 'structure-change']
              });
              return; // Bot yahi ruk jayega, Merge nahi karega.
            }

            // CASE B: Merge Conflicts (System Safety)
            if (isMergeable === false) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `### ‚ùå Merge Conflict Detected
                
                Another contribution was merged recently which conflicts with your changes.
                
                **Action Required:**
                Please sync your branch with the main repository and resolve the conflicts to proceed.`
              });
              return; // Stop here
            }

            // CASE C: All Good -> Auto Merge (Professional & Clean)
            if (fileCheckPassed && isMergeable !== false) {
              
              // Step 1: Formal Approval
              await github.rest.pulls.createReview({
                owner, repo, pull_number: prNumber, event: 'APPROVE', body: "‚úÖ **AI Review:** Code follows contribution guidelines. Approved for merge."
              });

              // Step 2: Professional Analysis Comment (No filenames mentioned)
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: `### ü§ñ AI Analysis Report
                
                | Category | Status |
                | :--- | :--- |
                | **File Integrity** | ‚úÖ Passed |
                | **Conflict Check** | ‚úÖ Passed |
                | **Code Quality** | ‚úÖ Standard Compliant |

                **Result:** The changes are verified and safe. Proceeding with automatic merge.`
              });

              // Step 3: Merge Operation
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                
                // Final Congratulatory Message
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body: `üéâ **Contribution Merged!**
                  
                  Congratulations **@${actor}**, your changes are now live in the repository. Thank you for contributing to Open Source! üèÜ`
                });
              } catch (e) {
                console.log(e);
                await github.rest.issues.createComment({
                  owner, repo, issue_number: prNumber, body: `‚ö†Ô∏è **System Error:** Merge failed unexpectedly. A maintainer has been notified.`
                });
              }
            }
            
